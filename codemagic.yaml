workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      # App Store Connect API key is configured in Codemagic UI as: apppleapikey (Key: 2RD5XCC7GH)
      # CodeMagic will automatically use it for code signing
    
    # Integrations - required for App Store Connect publishing and code signing
    # NEW API KEY (with Admin access):
    # - Name: prodoc_api_key_admin
    # - Key ID: 2SXY3XRQDL
    # - Issuer ID: 24e51026-b46d-49ab-89ba-d7791751dfd5
    # - Access: Admin ✅
    # - Private Key: AuthKey_2SXY3XRQDL.p8 (will be used from repository)
    #
    # OPTION 1: Use integration (if configured in Codemagic UI)
    # OPTION 2: Use environment variables (set in Codemagic UI → Environment variables)
    # OPTION 3: Use files from repository (configured below)
    integrations:
      app_store_connect: prodoc_api_key_admin  # API key with Admin access (Key ID: 2SXY3XRQDL)
    
    # Environment variables (set these in Codemagic UI → Environment variables as backup)
    # If integration doesn't work, these will be used:
    # - APP_STORE_CONNECT_API_KEY_ID = 2SXY3XRQDL
    # - APP_STORE_CONNECT_ISSUER_ID = 24e51026-b46d-49ab-89ba-d7791751dfd5
    # - APP_STORE_CONNECT_API_KEY = (content of AuthKey_2SXY3XRQDL.p8 file)
        
    # Cache configuration
    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/Library/Caches/CocoaPods
        - $HOME/.cocoapods
        - $HOME/.gradle/caches
        - Pods
        - ios/Pods
        - ios/Flutter/Flutter.framework
        - ios/Flutter/Flutter.podspec

    scripts:
      # Code signing is handled automatically by Codemagic using the app_store_connect integration
      # The integration 'prodoc_api_key_admin' is configured in Codemagic UI
      # Codemagic will automatically fetch certificates and profiles
      
      - name: Set up code signing
        script: |
          echo "=========================================="
          echo "Setting up code signing"
          echo "=========================================="
          echo "Integration: prodoc_api_key_admin"
          echo "Team ID: JT4YJSSV45"
          echo "Bundle ID: com.nextpital.prodoc"
          echo ""
          
          # Initialize keychain
          echo "Initializing keychain..."
          keychain initialize
          
          # Try to fetch signing files using Codemagic's automatic integration
          # The integration should provide environment variables automatically
          echo "Fetching signing files from App Store Connect..."
          app-store-connect fetch-signing-files com.nextpital.prodoc \
            --type IOS_APP_STORE \
            --create \
            --platform IOS 2>&1 | tee /tmp/fetch_signing.log || {
            echo "⚠ First attempt failed, trying without --create flag..."
            app-store-connect fetch-signing-files com.nextpital.prodoc \
              --type IOS_APP_STORE \
              --platform IOS 2>&1 | tee -a /tmp/fetch_signing.log || {
              echo "⚠ Fetch failed, checking log:"
              tail -30 /tmp/fetch_signing.log || true
            }
          }
          
          # Add certificates to keychain
          echo ""
          echo "Adding certificates to keychain..."
          keychain add-certificates 2>&1 | tee /tmp/add_certs.log || {
            echo "⚠ keychain add-certificates had issues"
            ls -la ~/Library/MobileDevice/Certificates/ 2>/dev/null || echo "No certificate files found"
          }
          
          # Copy provisioning profile from repository if it exists
          echo ""
          echo "Setting up provisioning profile from repository..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          PROFILE_FILE=""
          for possible_path in \
            "Prodoc_Medical_Management_App_ios_app_store_1767979241.mobileprovision" \
            "./Prodoc_Medical_Management_App_ios_app_store_1767979241.mobileprovision"; do
            if [ -f "$possible_path" ]; then
              PROFILE_FILE="$possible_path"
              break
            fi
          done
          
          if [ -n "$PROFILE_FILE" ] && [ -f "$PROFILE_FILE" ]; then
            EXTRACTED_UUID=$(security cms -D -i "$PROFILE_FILE" 2>/dev/null | grep -A1 "<key>UUID</key>" | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d ' ' || echo "")
            if [ -n "$EXTRACTED_UUID" ]; then
              PROFILE_UUID="$EXTRACTED_UUID"
            else
              PROFILE_UUID="03ce1337-38eb-4b45-946f-4ddbe9343e88"
            fi
            
            TARGET_PROFILE=~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
            cp "$PROFILE_FILE" "$TARGET_PROFILE"
            chmod 644 "$TARGET_PROFILE"
            echo "✓ Provisioning profile copied: $TARGET_PROFILE"
          fi
          
          # Verify code signing setup
          echo ""
          echo "Code signing resources:"
          CERT_COUNT=$(security find-identity -v -p codesigning 2>/dev/null | grep -c "JT4YJSSV45" || echo "0")
          PROFILE_COUNT=$(ls -1 ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision 2>/dev/null | wc -l || echo "0")
          echo "Certificates: $CERT_COUNT"
          echo "Profiles: $PROFILE_COUNT"
          
          if [ "$CERT_COUNT" -eq "0" ] || [ "$PROFILE_COUNT" -eq "0" ]; then
            echo ""
            echo "⚠ WARNING: Code signing setup incomplete"
            echo "  Certificates: $CERT_COUNT"
            echo "  Profiles: $PROFILE_COUNT"
            echo ""
            echo "Make sure the integration 'prodoc_api_key_admin' is configured in Codemagic UI"
          else
            echo ""
            echo "✓ Code signing setup successful!"
          fi
      
      - name: Create privacy manifests before build
        script: |
          echo "Creating privacy manifest files before build..."
          bash ios/create_privacy_manifests_pre_build.sh
          
      - name: Clean iOS build
        script: |
          flutter clean
          cd ios
          rm -rf Pods Podfile.lock
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          rm -rf build/
          cd ..
          
      - name: Get Flutter dependencies
        script: |
          flutter pub get
          
      - name: Install CocoaPods dependencies
        script: |
          cd ios
          pod deintegrate || true
          pod cache clean --all || true
          # Ensure xcodeproj gem is available for Podfile script
          gem install xcodeproj || true
          pod install --repo-update
          cd ..
          
          # After pod install, create privacy manifests in DerivedData
          # This must happen before any Xcode build starts
          echo "Creating privacy manifests in DerivedData after pod install..."
          DERIVED_DATA_BASE="$HOME/Library/Developer/Xcode/DerivedData"
          CRITICAL_PACKAGES="url_launcher_ios sqflite_darwin"
          
          # Create in all possible Runner-* directories (current and future)
          # We create the full path structure even if it doesn't exist yet
          for runner_dir in "$DERIVED_DATA_BASE"/Runner-*; do
            if [ -d "$runner_dir" ] || mkdir -p "$runner_dir" 2>/dev/null; then
              uninstalled_dir="${runner_dir}/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos"
              mkdir -p "$uninstalled_dir"
              for package in $CRITICAL_PACKAGES; do
                BUNDLE_DIR="${uninstalled_dir}/${package}_privacy.bundle"
                mkdir -p "$BUNDLE_DIR"
                touch "${BUNDLE_DIR}/${package}_privacy"
                chmod 644 "${BUNDLE_DIR}/${package}_privacy"
                echo "Created: ${BUNDLE_DIR}/${package}_privacy"
              done
            fi
          done
          
          # Also create a template structure for future builds
          TEMPLATE_DIR="${DERIVED_DATA_BASE}/Runner-template/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos"
          mkdir -p "$TEMPLATE_DIR"
          for package in $CRITICAL_PACKAGES; do
            BUNDLE_DIR="${TEMPLATE_DIR}/${package}_privacy.bundle"
            mkdir -p "$BUNDLE_DIR"
            touch "${BUNDLE_DIR}/${package}_privacy"
            chmod 644 "${BUNDLE_DIR}/${package}_privacy"
          done
          
      - name: Create privacy manifest placeholders after pod install
        script: |
          # Create privacy manifest files immediately after pod install
          # This ensures they exist before Xcode tries to use them as build inputs
          echo "Creating privacy manifest placeholders..."
          
          CRITICAL_PACKAGES="url_launcher_ios sqflite_darwin shared_preferences_foundation path_provider_foundation flutter_secure_storage flutter_local_notifications share_plus"
          
          # Create in build directory
          BUILD_DIR="build/ios/Release-iphoneos"
          mkdir -p "$BUILD_DIR"
          
          for package in $CRITICAL_PACKAGES; do
            BUNDLE_DIR="${BUILD_DIR}/${package}_privacy.bundle"
            mkdir -p "$BUNDLE_DIR"
            touch "${BUNDLE_DIR}/${package}_privacy"
            chmod 644 "${BUNDLE_DIR}/${package}_privacy"
            echo "Created placeholder: ${BUNDLE_DIR}/${package}_privacy"
          done
          
      - name: Verify Podfile script phases
        script: |
          # Verify that Podfile has privacy manifest script phases
          # The Podfile script phase should handle all packages automatically
          echo "Checking Podfile for privacy manifest script phases..."
          if grep -q "Create Privacy Manifest" ios/Podfile; then
            echo "✓ Podfile contains privacy manifest script phases"
          else
            echo "⚠ Podfile might not have privacy manifest script phases"
          fi
          
      - name: Flutter analyze
        script: |
          # Run analyze but don't fail build on warnings/infos (only fail on actual errors)
          # Use || true to continue even if analyze finds issues
          flutter analyze --no-fatal-infos --no-fatal-warnings || true
          
      - name: Flutter test
        script: |
          flutter test || true  # Continue even if tests fail for now
          
      - name: Create privacy manifests right before build
        script: |
          # Create privacy manifest files immediately before build
          # For archive builds, Xcode looks in DerivedData/ArchiveIntermediates/UninstalledProducts
          # For regular builds, Xcode looks in build/ios/Release-iphoneos
          echo "Creating privacy manifest files right before build..."
          
          # List of packages that commonly need privacy manifests
          CRITICAL_PACKAGES="url_launcher_ios sqflite_darwin shared_preferences_foundation path_provider_foundation flutter_secure_storage flutter_local_notifications share_plus"
          
          # Function to create privacy manifest for a package in a specific location
          create_privacy_manifest_in_dir() {
            local package=$1
            local base_dir=$2
            if [ -z "$package" ] || [ -z "$base_dir" ]; then
              return
            fi
            
            # Create privacy bundle directly (not in a package subdirectory for archive builds)
            BUNDLE_DIR="${base_dir}/${package}_privacy.bundle"
            mkdir -p "$BUNDLE_DIR"
            # Create an empty file - privacy bundles are resource-only and don't need a binary
            touch "${BUNDLE_DIR}/${package}_privacy" || true
            chmod 644 "${BUNDLE_DIR}/${package}_privacy" || true
            echo "Created: ${BUNDLE_DIR}/${package}_privacy"
          }
          
          # Create in regular build directory
          BUILD_DIR="build/ios/Release-iphoneos"
          mkdir -p "$BUILD_DIR"
          for package in $CRITICAL_PACKAGES; do
            create_privacy_manifest_in_dir "$package" "$BUILD_DIR"
          done
          
          # Also create in DerivedData locations (for archive builds)
          # Find the DerivedData directory for this project
          DERIVED_DATA_BASE="$HOME/Library/Developer/Xcode/DerivedData"
          if [ -d "$DERIVED_DATA_BASE" ]; then
            # Create privacy manifests in potential archive build locations
            # The path structure is: Runner-*/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos
            for runner_dir in "$DERIVED_DATA_BASE"/Runner-*; do
              if [ -d "$runner_dir" ]; then
                uninstalled_dir="${runner_dir}/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos"
                mkdir -p "$uninstalled_dir"
                for package in $CRITICAL_PACKAGES; do
                  create_privacy_manifest_in_dir "$package" "$uninstalled_dir"
                done
                echo "Created privacy manifests in DerivedData location: $uninstalled_dir"
              fi
            done
          fi
          
          # Verify critical packages
          echo "Verifying privacy manifests for critical packages..."
          for package in url_launcher_ios sqflite_darwin; do
            MANIFEST_PATH="${BUILD_DIR}/${package}_privacy.bundle/${package}_privacy"
            if [ -f "$MANIFEST_PATH" ]; then
              echo "✓ ${package} privacy manifest exists at: $MANIFEST_PATH"
            else
              echo "✗ ${package} privacy manifest NOT found at: $MANIFEST_PATH"
            fi
          done
          
          echo "Privacy manifest files created and verified"
          
      - name: Build iOS IPA
        script: |
          # Function to create privacy manifest files in all possible locations
          create_privacy_manifests() {
            # List of packages that need privacy manifests
            CRITICAL_PACKAGES="url_launcher_ios sqflite_darwin shared_preferences_foundation path_provider_foundation flutter_secure_storage flutter_local_notifications share_plus"
            
            # Create in regular build directory
            BUILD_DIR="build/ios/Release-iphoneos"
            mkdir -p "$BUILD_DIR"
            
            for package in $CRITICAL_PACKAGES; do
              # Create privacy bundle directly in build directory
              BUNDLE_DIR="${BUILD_DIR}/${package}_privacy.bundle"
              mkdir -p "$BUNDLE_DIR"
              touch "${BUNDLE_DIR}/${package}_privacy" || true
              chmod 644 "${BUNDLE_DIR}/${package}_privacy" || true
              echo "Created: ${BUNDLE_DIR}/${package}_privacy"
            done
            
            # Also create in DerivedData locations for archive builds
            # The error shows: DerivedData/Runner-*/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos
            DERIVED_DATA_BASE="$HOME/Library/Developer/Xcode/DerivedData"
            if [ -d "$DERIVED_DATA_BASE" ]; then
              # Find all Runner-* directories in DerivedData
              for runner_dir in "$DERIVED_DATA_BASE"/Runner-*; do
                if [ -d "$runner_dir" ]; then
                  uninstalled_dir="${runner_dir}/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos"
                  mkdir -p "$uninstalled_dir"
                  for package in $CRITICAL_PACKAGES; do
                    BUNDLE_DIR="${uninstalled_dir}/${package}_privacy.bundle"
                    mkdir -p "$BUNDLE_DIR"
                    touch "${BUNDLE_DIR}/${package}_privacy" || true
                    chmod 644 "${BUNDLE_DIR}/${package}_privacy" || true
                    echo "Created in DerivedData: ${BUNDLE_DIR}/${package}_privacy"
                  done
                fi
              done
            fi
          }
          
          # Create privacy manifests before build
          create_privacy_manifests
          
          # Final safety check: Create files right before build starts
          # This ensures they exist even if script phases don't run
          echo "Final check: Creating privacy manifests in all possible locations..."
          DERIVED_DATA_BASE="$HOME/Library/Developer/Xcode/DerivedData"
          CRITICAL_PACKAGES="url_launcher_ios sqflite_darwin"
          
          # Create in all existing Runner-* directories
          if [ -d "$DERIVED_DATA_BASE" ]; then
            for runner_dir in "$DERIVED_DATA_BASE"/Runner-*; do
              if [ -d "$runner_dir" ] || mkdir -p "$runner_dir" 2>/dev/null; then
                uninstalled_dir="${runner_dir}/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos"
                mkdir -p "$uninstalled_dir"
                for package in $CRITICAL_PACKAGES; do
                  BUNDLE_DIR="${uninstalled_dir}/${package}_privacy.bundle"
                  mkdir -p "$BUNDLE_DIR"
                  touch "${BUNDLE_DIR}/${package}_privacy"
                  chmod 644 "${BUNDLE_DIR}/${package}_privacy"
                  echo "✓ Created: ${BUNDLE_DIR}/${package}_privacy"
                done
              fi
            done
          fi
          
          # Also create in a generic location that Xcode might use
          # Based on the error: Runner-edaimyiflreloheqntgnhkmwcclv
          GENERIC_RUNNER_DIR="${DERIVED_DATA_BASE}/Runner-edaimyiflreloheqntgnhkmwcclv"
          if [ ! -d "$GENERIC_RUNNER_DIR" ]; then
            mkdir -p "$GENERIC_RUNNER_DIR/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos"
            for package in $CRITICAL_PACKAGES; do
              BUNDLE_DIR="${GENERIC_RUNNER_DIR}/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos/${package}_privacy.bundle"
              mkdir -p "$BUNDLE_DIR"
              touch "${BUNDLE_DIR}/${package}_privacy"
              chmod 644 "${BUNDLE_DIR}/${package}_privacy"
              echo "✓ Created in generic location: ${BUNDLE_DIR}/${package}_privacy"
            done
          fi
          
          # Create a wrapper script that creates privacy manifests before each Xcode invocation
          echo '#!/bin/bash' > /tmp/pre_build_privacy_manifests.sh
          echo 'DERIVED_DATA_BASE="$HOME/Library/Developer/Xcode/DerivedData"' >> /tmp/pre_build_privacy_manifests.sh
          echo 'CRITICAL_PACKAGES="url_launcher_ios sqflite_darwin"' >> /tmp/pre_build_privacy_manifests.sh
          echo 'create_privacy_files() {' >> /tmp/pre_build_privacy_manifests.sh
          echo '  local base_dir=$1' >> /tmp/pre_build_privacy_manifests.sh
          echo '  if [ -z "$base_dir" ] || [ ! -d "$(dirname "$base_dir")" ]; then return 0; fi' >> /tmp/pre_build_privacy_manifests.sh
          echo '  mkdir -p "$base_dir"' >> /tmp/pre_build_privacy_manifests.sh
          echo '  for package in $CRITICAL_PACKAGES; do' >> /tmp/pre_build_privacy_manifests.sh
          echo '    BUNDLE_DIR="${base_dir}/${package}_privacy.bundle"' >> /tmp/pre_build_privacy_manifests.sh
          echo '    mkdir -p "$BUNDLE_DIR"' >> /tmp/pre_build_privacy_manifests.sh
          echo '    touch "${BUNDLE_DIR}/${package}_privacy"' >> /tmp/pre_build_privacy_manifests.sh
          echo '    chmod 644 "${BUNDLE_DIR}/${package}_privacy"' >> /tmp/pre_build_privacy_manifests.sh
          echo '  done' >> /tmp/pre_build_privacy_manifests.sh
          echo '}' >> /tmp/pre_build_privacy_manifests.sh
          echo 'if [ -d "$DERIVED_DATA_BASE" ]; then' >> /tmp/pre_build_privacy_manifests.sh
          echo '  for runner_dir in "$DERIVED_DATA_BASE"/Runner-*; do' >> /tmp/pre_build_privacy_manifests.sh
          echo '    if [ -d "$runner_dir" ]; then' >> /tmp/pre_build_privacy_manifests.sh
          echo '      uninstalled_dir="${runner_dir}/Build/Intermediates.noindex/ArchiveIntermediates/Runner/IntermediateBuildFilesPath/UninstalledProducts/iphoneos"' >> /tmp/pre_build_privacy_manifests.sh
          echo '      create_privacy_files "$uninstalled_dir"' >> /tmp/pre_build_privacy_manifests.sh
          echo '    fi' >> /tmp/pre_build_privacy_manifests.sh
          echo '  done' >> /tmp/pre_build_privacy_manifests.sh
          echo 'fi' >> /tmp/pre_build_privacy_manifests.sh
          chmod +x /tmp/pre_build_privacy_manifests.sh
          
          # Build IPA - use xcodebuild directly to have more control
          # This allows us to inject a pre-build script
          echo "Building iOS app with Flutter..."
          
          # Set up environment for Flutter build
          export FLUTTER_BUILD_MODE=release
          
          # Create privacy manifests one more time right before build
          /tmp/pre_build_privacy_manifests.sh
          
          # Ensure profiles are available before build
          echo "Checking for provisioning profiles..."
          if [ -d ~/Library/MobileDevice/Provisioning\ Profiles ]; then
            echo "Provisioning profiles directory exists"
            PROFILE_COUNT=$(ls -1 ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision 2>/dev/null | wc -l || echo "0")
            echo "Found $PROFILE_COUNT provisioning profile(s)"
            if [ "$PROFILE_COUNT" -gt "0" ]; then
              echo "Profile details:"
              ls -1 ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision 2>/dev/null | head -3 | while read profile; do
                echo "  - $(basename "$profile")"
                # Check if it's for our bundle ID
                if security cms -D -i "$profile" 2>/dev/null | grep -q "com.nextpital.prodoc"; then
                  echo "    ✓ Matches bundle ID com.nextpital.prodoc"
                fi
              done
            fi
          else
            echo "⚠ Provisioning profiles directory not found"
          fi
          
          # Check certificates
          echo ""
          echo "Checking code signing certificates..."
          security find-identity -v -p codesigning 2>/dev/null | grep "JT4YJSSV45" || echo "No certificates found for team JT4YJSSV45"
          
          # Build using flutter build ipa with release mode
          # We need to ensure export options use App Store method (not Development)
          echo ""
          echo "Creating export options for App Store distribution..."
          
          # Create export options plist for App Store distribution using echo (YAML-safe)
          echo '<?xml version="1.0" encoding="UTF-8"?>' > /tmp/export_options.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> /tmp/export_options.plist
          echo '<plist version="1.0">' >> /tmp/export_options.plist
          echo '<dict>' >> /tmp/export_options.plist
          echo '    <key>method</key>' >> /tmp/export_options.plist
          echo '    <string>app-store</string>' >> /tmp/export_options.plist
          echo '    <key>teamID</key>' >> /tmp/export_options.plist
          echo '    <string>JT4YJSSV45</string>' >> /tmp/export_options.plist
          echo '    <key>signingStyle</key>' >> /tmp/export_options.plist
          echo '    <string>automatic</string>' >> /tmp/export_options.plist
          echo '    <key>uploadBitcode</key>' >> /tmp/export_options.plist
          echo '    <false/>' >> /tmp/export_options.plist
          echo '    <key>uploadSymbols</key>' >> /tmp/export_options.plist
          echo '    <true/>' >> /tmp/export_options.plist
          echo '</dict>' >> /tmp/export_options.plist
          echo '</plist>' >> /tmp/export_options.plist
          
          echo "Export options created:"
          cat /tmp/export_options.plist
          echo ""
          
          # Verify Xcode project is configured for Release builds
          echo "Verifying Xcode project configuration..."
          cd ios
          CONFIGURATION=$(xcodebuild -project Runner.xcodeproj -target Runner -showBuildSettings 2>/dev/null | grep "CONFIGURATION" | head -1 | sed 's/.*= *//' | tr -d ' ' || echo "")
          if [ "$CONFIGURATION" != "Release" ]; then
            echo "⚠ Warning: Build configuration is '$CONFIGURATION' (expected: Release)"
            echo "  Flutter build ipa should use Release, but Xcode might be using different config"
          else
            echo "✓ Build configuration: Release"
          fi
          cd ..
          echo ""
          
          echo "Starting Flutter build with App Store export options..."
          flutter build ipa --release --export-options-plist /tmp/export_options.plist 2>&1 | tee /tmp/flutter_build.log || BUILD_FAILED=1
          
          # If build failed, try to create files and retry once
          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            if grep -qi "Build input file cannot be found.*privacy.*bundle" /tmp/flutter_build.log; then
              echo "Privacy manifest error detected, creating files in all locations and retrying..."
              create_privacy_manifests
              sleep 2
              flutter build ipa --release --export-options-plist /tmp/export_options.plist 2>&1 | tee /tmp/flutter_build.log || BUILD_FAILED=1
            fi
          fi
          
          # If build failed due to privacy manifest, try to create files and retry once
          if [ "$BUILD_FAILED" = "1" ] && grep -qi "Build input file cannot be found.*privacy.*bundle" /tmp/flutter_build.log; then
            echo "Privacy manifest error detected, creating files and retrying..."
            /tmp/create_privacy_manifests.sh
            # Small delay to ensure files are written
            sleep 2
            flutter build ipa --release --export-options-plist /tmp/export_options.plist 2>&1 | tee /tmp/flutter_build.log || BUILD_FAILED=1
          fi
            
          if [ "$BUILD_FAILED" = "1" ]; then
            echo "=========================================="
            echo "Build failed! Analyzing errors..."
            echo "=========================================="
            
            # Show errors from Flutter output
            echo ""
            echo "=== Errors in Flutter build output ==="
            grep -i "error\|failed\|cannot be found" /tmp/flutter_build.log | tail -20 || true
            
            # Check for Xcode build logs
            echo ""
            echo "=== Checking Xcode build logs ==="
            XCODE_LOG=$(find ~/Library/Developer/Xcode/DerivedData -name "*.log" -type f -mmin -10 2>/dev/null | head -1)
            if [ -n "$XCODE_LOG" ]; then
              echo "Found Xcode log: $XCODE_LOG"
              echo "Last 50 lines with errors:"
              grep -i "error\|failed\|cannot be found" "$XCODE_LOG" | tail -20 || true
            else
              echo "Xcode log not found in DerivedData"
            fi
            
            # Check for privacy manifest errors specifically
            if grep -qi "Build input file cannot be found\|privacy.*bundle" /tmp/flutter_build.log; then
              echo ""
              echo "=========================================="
              echo "PRIVACY MANIFEST ERROR DETECTED!"
              echo "=========================================="
              grep -i "Build input file cannot be found\|privacy.*bundle" /tmp/flutter_build.log | head -10
              echo ""
              echo "Attempting to create missing privacy manifests..."
              create_privacy_manifests
              echo "Created privacy manifests."
            fi
            
            # Show full error context from build log
            echo ""
            echo "=== Full error context (last 200 lines) ==="
            tail -200 /tmp/flutter_build.log | grep -A 5 -B 5 -i "error\|failed\|cannot" || tail -50 /tmp/flutter_build.log
            
            # Check if privacy manifests exist
            echo ""
            echo "=== Checking privacy manifest files ==="
            for pkg in url_launcher_ios sqflite_darwin shared_preferences_foundation share_plus; do
              if [ -f "build/ios/Release-iphoneos/${pkg}/${pkg}_privacy.bundle/${pkg}_privacy" ]; then
                echo "✓ ${pkg} privacy manifest exists"
              else
                echo "✗ ${pkg} privacy manifest NOT found"
              fi
            done
            
            # List all created privacy manifests
            echo ""
            echo "=== All privacy manifest files ==="
            find build/ios/Release-iphoneos -type f -path "*_privacy.bundle/*" -o -path "*_Privacy.bundle/*" -o -path "*.bundle/*" 2>/dev/null | head -30 || echo "No privacy manifest files found"
            
            exit 1
          fi
          
      - name: Verify build artifacts
        script: |
          echo "=========================================="
          echo "Verifying build artifacts..."
          echo "=========================================="
          
          # Check for .app file
          if [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
            echo "✓ Found Runner.app at: build/ios/Release-iphoneos/Runner.app"
            ls -lh build/ios/Release-iphoneos/Runner.app
          elif [ -d "build/ios/iphoneos/Runner.app" ]; then
            echo "✓ Found Runner.app at: build/ios/iphoneos/Runner.app"
            ls -lh build/ios/iphoneos/Runner.app
          else
            echo "✗ Runner.app not found in expected locations"
            echo "Searching for .app files..."
            find build/ios -name "*.app" -type d 2>/dev/null || echo "No .app files found"
          fi
          
          # Check for .ipa file
          if [ -f "build/ios/ipa/*.ipa" ]; then
            echo "✓ Found .ipa file"
            ls -lh build/ios/ipa/*.ipa
          else
            echo "No .ipa file found (expected for --no-codesign build)"
          fi
          
          echo ""
          echo "Build directory structure:"
          ls -la build/ios/ 2>/dev/null || echo "build/ios/ directory not found"
          
      # Optional: Run iOS tests
      # - name: Run iOS tests
      #   script: |
      #     cd ios
      #     xcodebuild test \
      #       -workspace Runner.xcworkspace \
      #       -scheme Runner \
      #       -destination 'platform=iOS Simulator,name=iPhone 15' \
      #       -enableCodeCoverage YES \
      #       | xcpretty
          
        
    artifacts:
      - build/ios/Release-iphoneos/*.app
      - build/ios/iphoneos/*.app
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - /tmp/flutter_build.log
      
    publishing:
      email:
        recipients:
          - omarlamzah64@gmail.com  # Your email from git config
        notify:
          success: true
          failure: true
      # App Store Connect publishing configuration
      # Uses the API key: myappkey_admin_forcodemajic (Key: 87FW8F4TSV, Access: Admin)
      app_store_connect:
        auth: integration  # Uses the App Store Connect API key configured in Codemagic UI
        # submit_to_testflight: false  # Uncomment to disable TestFlight submission
        # beta_groups:  # Uncomment and add beta group names if needed
        #   - group name 1
        #   - group name 2
      
      # Uncomment for Slack notifications
      # slack:
      #   channel: '#builds'
      #   notify_on_build_start: true
      #   notify:
      #     success: true
      #     failure: true
